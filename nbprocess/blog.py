# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/15_blog.ipynb.

# %% auto 0
__all__ = ['cat_slug', 'file_slug', 'migrate_nb_fm', 'md_fmdict', 'migrate_md_fm']

# %% ../nbs/15_blog.ipynb 3
from .processors import nb_fmdict, construct_fm, insert_frontmatter, is_frontmatter
from .read import read_nb
from .sync import write_nb
from fastcore.all import *
from json import loads

# %% ../nbs/15_blog.ipynb 4
def _get_fm(path): return nb_fmdict(read_nb(path), remove=False)
def _get_raw_fm(nb): 
    return first(nb.cells.filter(lambda x: x.cell_type == 'raw')).source

# %% ../nbs/15_blog.ipynb 5
def cat_slug(fmdict):
    "Get the partial slug from the category front matter."
    cats = [c for c in fmdict.get('categories', '').strip().strip('][').split(', ') if c]
    return '/' + '/'.join(sorted(cats)) if cats else ''

# %% ../nbs/15_blog.ipynb 8
def file_slug(fname): 
    "Get the partial slug from the filename."
    p = Path(fname)
    dt = '/'+p.name[:10].replace('-', '/')+'/'
    return dt + p.stem[11:]    

# %% ../nbs/15_blog.ipynb 10
def _add_alias(fm:dict, path:Path):
    if 'permalink' in fm: fm['aliases'] = '[' + fm.pop('permalink').strip() + ']'
    else: fm['aliases'] = '[' + cat_slug(fm) + file_slug(path) + ']'

# %% ../nbs/15_blog.ipynb 11
def migrate_nb_fm(path, overwrite=True):
    "Migrate fastpages front matter in notebooks to a raw cell."
    nb = read_nb(path)
    if is_frontmatter(nb): return None
    fm = nb_fmdict(nb)
    _add_alias(fm, path)
    insert_frontmatter(nb, fm_dict=fm)
    if overwrite: write_nb(nb, path)
    return nb

# %% ../nbs/15_blog.ipynb 14
_re_fm_md = re.compile(r'^---(.*\S+.)?---', flags=re.DOTALL)

def md_fmdict(txt):
    "Get front matter as a dict from a markdown file."
    m = _re_fm_md.match(txt)
    if m:
        fm = [s.split(':', 1) for s in m.group(1).splitlines() if s]
        return {k:v.strip() for k,v in fm if k and v}
    else: return {}

# %% ../nbs/15_blog.ipynb 17
def migrate_md_fm(path, overwrite=True):
    "Make fastpages front matter in markdown files quarto compliant."
    p = Path(path)
    md = p.read_text()
    fm = md_fmdict(md)
    if fm:
        _add_alias(fm, path)
        txt = _re_fm_md.sub(construct_fm(fm), md)
        if overwrite: p.write_text(txt)
        return txt
    else: return md 

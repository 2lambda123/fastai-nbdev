# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/05_clean.ipynb.

# %% auto 0
__all__ = ['clean_nb', 'nbdev_clean_nbs']

# %% ../nbs/05_clean.ipynb 2
from fastcore.script import *
from fastcore.utils import *
from fastcore.imports import *

from .imports import *
from .read import *
from .sync import *

# from pathlib import Path
# import io,sys,json,glob,re

# %% ../nbs/05_clean.ipynb 6
def _clean_cell_output(cell):
    "Remove execution count in `cell`"
    if 'outputs' in cell:
        for o in cell['outputs']:
            if 'execution_count' in o: o['execution_count'] = None
            o.get('data',{}).pop("application/vnd.google.colaboratory.intrinsic+json", None)
            o.get('metadata', {}).pop('tags', None)

# %% ../nbs/05_clean.ipynb 7
def _clean_cell(cell, clear_all=False):
    "Clean `cell` by removing superfluous metadata or everything except the input if `clear_all`"
    if 'execution_count' in cell: cell['execution_count'] = None
    if 'outputs' in cell:
        if clear_all: cell['outputs'] = []
        else:         _clean_cell_output(cell)
    if cell['source'] == ['']: cell['source'] = []
    cell['metadata'] = {} if clear_all else {
        k:v for k,v in cell['metadata'].items() if k=="hide_input"}

# %% ../nbs/05_clean.ipynb 10
def clean_nb(nb, clear_all=False):
    "Clean `nb` from superfluous metadata, passing `clear_all` to `_clean_cell`"
    for c in nb['cells']: _clean_cell(c, clear_all=clear_all)
    nb['metadata'] = {k:v for k,v in nb['metadata'].items() if k in
                     ("kernelspec", "jekyll", "jupytext", "doc")}

# %% ../nbs/05_clean.ipynb 13
def _wrapio(strm): return io.TextIOWrapper(strm, encoding='utf-8', line_buffering=True)

# %% ../nbs/05_clean.ipynb 14
@call_parse
def nbdev_clean_nbs(
    fname:str=None, # A notebook name or glob to convert
    clear_all:bool_arg=False, # Clean all metadata and outputs
    disp:bool_arg=False, # Print the cleaned outputs
    read_input_stream:bool_arg=False # Read input stram and not nb folder
):
    "Clean all notebooks in `fname` to avoid merge conflicts"
    #Git hooks will pass the notebooks in the stdin
    if read_input_stream:
        nb = json.load(_wrapio(sys.stdin))
        clean_nb(nb, clear_all=clear_all)
        write_nb(nb, _wrapio(sys.stdout))
        return

    path = None
    if fname is None: path = get_config().path("nbs_path")
    files = nbglob(fname=ifnone(fname,path))
    for f in files:
        if not str(f).endswith('.ipynb'): continue
        nb = json.loads(open(f, 'r', encoding='utf-8').read())
        clean_nb(nb, clear_all=clear_all)
        if disp: _print_output(nb)
        else:
            x = json.dumps(nb, sort_keys=True, indent=1, ensure_ascii=False)
            with io.open(f, 'w', encoding='utf-8') as f:
                f.write(x)
                f.write("\n")
